<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Dorm Directory</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50 text-gray-900">
    <div id="loader" class="fixed inset-0 bg-white/80 flex items-center justify-center z-50">
      <div class="text-center">
        <svg class="animate-spin h-12 w-12 text-gray-700 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
        </svg>
        <div class="mt-2 text-gray-700">Loading dorms...</div>
      </div>
    </div>

    <div class="max-w-6xl mx-auto p-6">
      <header class="mb-6">
        <h1 class="text-3xl font-bold">Dorm Directory</h1>
        <p class="text-sm text-gray-600">Sample dorms from the example API</p>
      </header>

      <section class="mb-6 grid gap-3 sm:grid-cols-2 lg:grid-cols-4">
        <input id="search" type="search" placeholder="Search by name..." class="p-2 border rounded" />

        <select id="sexFilter" class="p-2 border rounded">
          <option value="All">All Sex</option>
        </select>

        <select id="quadFilter" class="p-2 border rounded">
          <option value="All">All Quads</option>
        </select>

        <button id="clear" class="p-2 bg-gray-200 rounded">Clear Filters</button>
      </section>

      <main>
        <div id="grid" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3"></div>
      </main>
    </div>

    <script>
    function showLoader(){ const l = document.getElementById('loader'); if(l) l.style.display = 'flex'; }
    function hideLoader(){ const l = document.getElementById('loader'); if(l) l.style.display = 'none'; }
    async function loadDorms() {
      const res = await fetch('https://script.google.com/macros/s/AKfycbwDb5eIffe6p7EviJU76MC7wcyIpIE2jAkU51lmV5FLjnvgNMTUyJVzfuXgsXEZ7uMt/exec');
      const json = await res.json();
      const headers = json.data.dorms.headers;
      const rows = json.data.dorms.rows;

      const dorms = rows.map(r => {
        const obj = {};
        headers.forEach((h, i) => (obj[h] = r[i]));
        return obj;
      });

      return dorms;
    }

    function renderGrid(dorms) {
      const grid = document.getElementById('grid');
      grid.innerHTML = '';
      dorms.forEach(d => {
        const card = document.createElement('div');
        card.className = 'bg-white p-4 rounded shadow';
        card.innerHTML = `
          <h2 class="font-semibold text-lg">${d.Name}</h2>
          <div class="text-sm text-gray-600">${d.Quad} â€¢ ${d.Sex}</div>
          <div class="mt-2 text-sm">
            <div><strong>Capacity:</strong> ${d.Capacity}</div>
            <div><strong>Colors:</strong> ${d.Colors}</div>
            <div><strong>Mascot:</strong> ${d.Mascot}</div>
            ${d.Notes ? `<div class="text-xs text-gray-500 mt-1">${d.Notes}</div>` : ''}
          </div>
        `;
        grid.appendChild(card);
      });
    }

    function setupFilters(dorms) {
      const sexSelect = document.getElementById('sexFilter');
      const quadSelect = document.getElementById('quadFilter');
      const searchInput = document.getElementById('search');
      const clearBtn = document.getElementById('clear');

      const sexes = Array.from(new Set(dorms.map(d => d.Sex))).sort();
      sexes.forEach(s => {
        const o = document.createElement('option'); o.value = s; o.textContent = s; sexSelect.appendChild(o);
      });

      const quads = Array.from(new Set(dorms.map(d => d.Quad))).sort();
      quads.forEach(q => {
        const o = document.createElement('option'); o.value = q; o.textContent = q; quadSelect.appendChild(o);
      });

      function apply() {
        const q = quadSelect.value;
        const s = sexSelect.value;
        const term = searchInput.value.trim().toLowerCase();

        const filtered = dorms.filter(d => {
          if (s !== 'All' && d.Sex !== s) return false;
          if (q !== 'All' && d.Quad !== q) return false;
          if (term && !d.Name.toLowerCase().includes(term)) return false;
          return true;
        });
        renderGrid(filtered);
      }

      sexSelect.addEventListener('change', apply);
      quadSelect.addEventListener('change', apply);
      searchInput.addEventListener('input', apply);
      clearBtn.addEventListener('click', () => {
        sexSelect.value = 'All';
        quadSelect.value = 'All';
        searchInput.value = '';
        renderGrid(dorms);
      });
    }

    async function init() {
      showLoader();
      try {
        const dorms = await loadDorms();
        setupFilters(dorms);
        renderGrid(dorms);
      } catch (err) {
        console.error(err);
      } finally {
        hideLoader();
      }
    }

    init().catch(err => console.error(err));
    </script>
  </body>
</html>
